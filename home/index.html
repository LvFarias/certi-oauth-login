<!doctype html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Home</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
			rel="stylesheet"
		/>
		<style>
			* {
				margin: 0;
				padding: 0;
				font-family: Roboto;
				box-sizing: border-box;
			}
			body {
				display: flex;
				width: 100dvw;
				height: 100dvh;
				align-items: center;
				background-size: cover;
				justify-content: center;
				background-position: center;
				background-repeat: no-repeat;
				background-image: url('../assets/backgroud.png');
			}
			.home-card {
				gap: 1.5rem;
				width: 450px;
				padding: 2rem;
				display: flex;
				max-width: 90dvw;
				text-align: center;
				border-radius: 1rem;
				background: #ecfefd;
				flex-direction: column;
				animation: fadeIn 1s ease;
				box-shadow: 0 0.5rem 1.5rem rgba(14, 1, 20, 0.5);
			}
			.home-card h1 {
				color: #0e0114;
				margin-bottom: 1rem;
			}
			.info-text {
				font-size: 1.2rem;
				color: #0e0114;
			}
			.info-text strong {
				color: #8a05be;
				font-size: 1.3rem;
				display: block;
				margin-top: 0.5rem;
			}
			.user-details {
				gap: 1rem;
				display: flex;
				margin-top: 1rem;
				text-align: left;
				flex-direction: column;
			}
			.detail-item {
				font-size: 1.1rem;
			}
			.detail-item img {
				width: 50px;
			}
			@keyframes fadeIn {
				from {
					opacity: 0;
				}
				to {
					opacity: 1;
				}
			}
		</style>
	</head>
	<body>
		<div class="home-card">
			<div class="info-text">
				Validando oauth:
				<div class="oauth-details">
					<div class="detail-item">
						<strong>UserId:</strong> <span id="userId"></span>
					</div>
					<div class="detail-item">
						<strong>Document:</strong>
						<span id="userDocument"></span>
					</div>
					<div class="detail-item">
						<strong>ContextId:</strong> <span id="contextId"></span>
					</div>
					<div class="detail-item">
						<strong>CertificateId:</strong>
						<span id="certificateId"></span>
					</div>
					<div class="detail-item">
						<strong>Recuperando Certificado:</strong>
						<img
							id="certificate-loading"
							src="../assets/loading.svg"
						/>
						<span id="certificate-detail"></span>
					</div>
					<div class="detail-item">
						<strong>Assinando Documento:</strong>
						<img
							id="signature-loading"
							src="../assets/loading.svg"
						/>
						<span id="signature-detail"></span>
					</div>
					<div class="detail-item">
						<strong>Validando Assinatura:</strong>
						<img
						id="validate-loading"
						src="../assets/loading.svg"
						/>
						<span id="validate-detail"></span>
					</div>
				</div>
			</div>
		</div>

		<script>
			function getCertificate(token) {
				const vars = JSON.parse(
					localStorage.getItem('envVars') || '{}',
				);
				var XHR = new XMLHttpRequest();
				XHR.open(
					'GET',
					`${vars.baseUrl}/api/emr-digital-signature/certificate`,
					true,
				);
				XHR.setRequestHeader('Authorization', 'Bearer ' + token);
				XHR.setRequestHeader('content-type', 'application/json');
				XHR.send();
				XHR.onreadystatechange = function () {
					if (XHR.readyState == 4) {
						console.log(XHR.status);
						if (XHR.status == 200) {
							console.log(XHR.responseText);
							const certificate = JSON.parse(XHR.responseText);
							document.getElementById(
								'certificate-loading',
							).style.display = 'none';
							document.getElementById(
								'certificate-detail',
							).innerHTML = `
								Nome: ${certificate?.name}<br>
								Document: ${certificate?.cpf}<br>
								Emissor: ${certificate?.issuer}<br>
								Número de Série: ${certificate?.serial_number}<br>
								Válido de: ${certificate?.valid_from}<br>
								Válido até: ${certificate?.valid_to}
							`;
							document.getElementById(
								'certificate-detail',
							).style.display = 'block';
						} else {
							document.getElementById(
								'certificate-loading',
							).style.display = 'none';
							document.getElementById(
								'certificate-detail',
							).textContent = "Erro ao recuperar o certificado";
							document.getElementById(
								'certificate-detail',
							).style.display = 'block';
						}
					}
				};
			}

			function signingDocument(token) {
				const vars = JSON.parse(
					localStorage.getItem('envVars') || '{}',
				);
				var XHR = new XMLHttpRequest();
				XHR.open(
					'POST',
					`${vars.baseUrl}/api/emr-digital-signature/signature`,
					true,
				);
				XHR.setRequestHeader('Authorization', 'Bearer ' + token);
				XHR.setRequestHeader('content-type', 'application/json');
				var body = {
					signature_format: 'DETACHED',
					signature_policy: 'CMS',
					hash_algorithm: '2.16.840.1.101.3.4.2.1',
					timezone: '-03:00UTC',
					hashes: [
						{
							id: 'Hello World',
							hash: 'pZGm1Av0IEBKARczz7exkNYsZb8LzaMrV7J32a2fFG4=',
						},
					],
				};
				XHR.send(JSON.stringify(body));
				XHR.onreadystatechange = function () {
					if (XHR.readyState == 4) {
						if (XHR.status == 200) {
							const result = JSON.parse(XHR.responseText);
							document.getElementById(
								'signature-loading',
							).style.display = 'none';
							document.getElementById(
								'signature-detail',
							).innerHTML = `
								${result?.message}<br>
								Assinado com: ${result?.certificate_alias}<br>
								Documento: ${result?.signatures?.[0]?.id}
							`;
							document.getElementById(
								'signature-detail',
							).style.display = 'block';
							validadeSignature(result?.signatures?.[0]?.raw_signature);
						} else {
							document.getElementById(
								'signature-loading',
							).style.display = 'none';
							document.getElementById(
								'signature-detail',
							).textContent = "Erro ao assinar o documento";
							document.getElementById(
								'signature-detail',
							).style.display = 'block';
							document.getElementById(
								'validate-loading',
							).style.display = 'none';
							document.getElementById(
								'validate-detail',
							).textContent = "Validação de assinatura não realizada";
							document.getElementById(
								'validate-detail',
							).style.display = 'block';
						}
					}
				};
			}

			function validadeSignature(raw_signature) {
				const vars = JSON.parse(
					localStorage.getItem('envVars') || '{}',
				);
				var XHR = new XMLHttpRequest();
				XHR.open(
					'POST',
					`${vars.baseUrl}/api/emr-digital-signature/validate`,
					true,
				);
				XHR.setRequestHeader('content-type', 'application/json');
				var body = {
					client_id: vars.clientId,
					signature_format: 'DETACHED',
					signature_policy: 'CMS',
					hash_algorithm: '2.16.840.1.101.3.4.2.1',
					timezone: '-03:00UTC',
					hashes: [
						{
							raw_signature,
							id: 'Hello World',
							hash: 'SGVsbG8gV29ybGQ=',
						},
					],
				};
				XHR.send(JSON.stringify(body));
				XHR.onreadystatechange = function () {
					if (XHR.readyState == 4) {
						if (XHR.status == 200) {
							const result = JSON.parse(XHR.responseText);
							document.getElementById(
								'validate-loading',
							).style.display = 'none';
							document.getElementById('validate-detail').textContent =
								`
								${result?.[0]?.status == 'SUCCESS' ? 'Assinatura válidada com sucesso' : 'Erro ao validar assinatura'}
							`;
							document.getElementById(
								'validate-detail',
							).style.display = 'block';
						} else {
							document.getElementById(
								'validate-loading',
							).style.display = 'none';
							document.getElementById(
								'validate-detail',
							).textContent = "Erro ao validar assinatura";
							document.getElementById(
								'validate-detail',
							).style.display = 'block';
						}
					}
				};
			}

			window.onload = function () {
				const userInfos = JSON.parse(
					localStorage.getItem('userInfos') || '{}',
				);

				document.getElementById('userId').textContent =
					userInfos.userId;
				document.getElementById('userDocument').textContent =
					userInfos.cpf;
				document.getElementById('contextId').textContent =
					userInfos.contextId;
				document.getElementById('certificateId').textContent =
					userInfos.certificateId;

				getCertificate(userInfos.authToken);
				signingDocument(userInfos.authToken);
			};
		</script>
	</body>
</html>
